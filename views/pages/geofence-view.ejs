<%- include('../partials/head') %>
<body>
<style>

  .content {
    flex: 1;
    padding: 30px 40px;
    background-color: #f9f9f9;
    border-radius: 0 20px 20px 0;
    font-family: "Roboto", sans-serif;
  }

  .content h2 {
    color: #692e69;
    margin-bottom: 15px;
  }

  .content p {
    color: #333;
    margin-bottom: 20px;
  }

 
  #geoTable {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-radius: 10px;
    overflow: hidden;
  }

  #geoTable th, #geoTable td {
    padding: 12px 15px;
    text-align: left;
  }

  #geoTable thead {
    background-color: #692e69;
    color: white;
    font-weight: bold;
  }

  #geoTable tbody tr {
    background-color: white;
    transition: background 0.3s;
  }

  #geoTable tbody tr:nth-child(even) {
    background-color: #f2f2f2;
  }

  #geoTable tbody tr:hover {
    background-color: #e0c0e0;
  }

  .status-cell span {
    font-weight: bold;
  }

 
  #map {
    width: 100%;
    height: 600px;
    border-radius: 15px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.2);
  }

  
  @media (max-width: 900px) {
    .content {
      padding: 20px;
      border-radius: 0;
    }
  }

  .editGeoBtn {
  background-color: #692e69;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: background-color 0.3s;
}

.editGeoBtn:hover {
  background-color: #8b3c8b;
}

  
  .deleteChildBtn {
    background-color: #d9534f;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s;
  }
  .deleteChildBtn:hover { background-color: #c9302c; }
</style>

  <%- include('../partials/top-nav-parents') %>

  <div class="main-container">
    <%- include('../partials/side-nav-parents') %>

    <main class="content">
      <h1 class="themed-heading">Children with Geofences</h1>
      <p>Logged in as: <%= parent.firstname %> <%= parent.lastname %></p>
    <h3>Check the Status column to see if child is within the Geofence.</h3>

    
    <div id="geoNotification" class="geo-notif" role="status" aria-live="polite" hidden></div>

      <% if (geofences.length === 0) { %>
        <p>No Records yet. Go to <a href="/register-child">Add Child</a>.</p>
      <% } else { %>
        

        <table id="geoTable" border="1" style="width:100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
              <tr>
                <th>Child</th>
                <th>Geofence Name</th>
                <th>Radius (m)</th>
                <th>Status</th>
                <th>Last Known Location</th>
                <th>Last Updated</th>
                <th>Action</th> 
              </tr>
            </thead>
            <tbody id="geoBody">
                <% geofences.forEach(g => { %>
                <tr 
                    data-fence-lat="<%= g.fence_lat %>" 
                    data-fence-lng="<%= g.fence_lng %>"
                    data-child-lat="<%= g.child_lat || '' %>"
                    data-child-lng="<%= g.child_lng || '' %>"
                    data-radius="<%= g.radius %>"
                >
                    <td class="child-name"><%= g.firstname %> <%= g.lastname %></td>
                    <td><%= g.geofence_name %></td>
                    <td><%= g.radius %></td>
                    <td class="status-cell">Calculating...</td>
                    <td class="location-cell">
                    <% if (g.child_lat && g.child_lng) { %>
                        <%= g.child_lat.toFixed(5) %>, <%= g.child_lng.toFixed(5) %>
                    <% } else { %>
                        <em>No data</em>
                    <% } %>
                    </td>
                    <td><%= g.date_time ? new Date(g.date_time).toLocaleString('en-PH') : '—' %></td>
                    <td>
                      <button 
                        class="deleteChildBtn"
                        data-child-id="<%= g.child_id %>"
                        data-child-name="<%= g.firstname %> <%= g.lastname %>">
                        Delete
                      </button>
                    </td>
                </tr>
                <% }) %>
            </tbody>
            </table>
           <!-- end table -->
      <% } %>
      <div id="map" style="height: 600px; width: 100%; border-radius: 8px;"></div>
    </main>
  </div>
  
  <style>
  
  .geo-notif {
  width: 100%;
  background: #ff3b3b;
  color: #fff;
  font-size: 1.2rem;
  font-weight: 700;
  text-align: center;
  border-radius: 10px;
  margin: 20px 0;
  padding: 16px;
  box-shadow: 0 6px 15px rgba(255, 0, 0, 0.3);
  border: 3px solid #fff;
  animation: pulseAlert 1s infinite;
  position: sticky;
  top: 0;
  z-index: 1000;
}

/* Pulse animation for visibility */
@keyframes pulseAlert {
  0% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 0, 0, 0.6); }
  50% { transform: scale(1.03); box-shadow: 0 0 25px rgba(255, 0, 0, 0.8); }
  100% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 0, 0, 0.6); }
}
  </style>
  
  <%- include('../partials/footer') %>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
const geofences = <%- JSON.stringify(geofences) %>;


const map = L.map('map').setView([10.3157, 123.8854], 12);

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap'
}).addTo(map);

function distance(lat1, lon1, lat2, lon2) {
  const R = 6371000; // meters
  const toRad = deg => deg * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = 
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

async function getReadableAddress(lat, lng) {
  try {
    const res = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
    );
    const data = await res.json();
    return data.display_name || "Address not found";
  } catch (err) {
    console.error("Error fetching address:", err);
    return "Unknown location";
  }
}

async function renderGeofences() {
  const allCoords = [];
  const outsideList = [];

  for (const g of geofences) {
    const fenceCenter = [g.fence_lat, g.fence_lng];
    const childLoc = g.child_lat && g.child_lng ? [g.child_lat, g.child_lng] : null;

    const fenceCircle = L.circle(fenceCenter, {
      radius: g.radius,
      color: 'blue',
      fillColor: '#3f8efc',
      fillOpacity: 0.3
    }).addTo(map)
      .bindPopup(`<b>${g.geofence_name}</b><br>Child: ${g.firstname} ${g.lastname}`);

    allCoords.push(fenceCenter);

    if (childLoc) {
      allCoords.push(childLoc);

      const dist = distance(g.child_lat, g.child_lng, g.fence_lat, g.fence_lng);
      const inside = dist <= g.radius;
      const markerColor = inside ? 'green' : 'red';

      
      if (!inside) {
        outsideList.push({
          name: `${g.firstname} ${g.lastname}`,
          dist: dist
        });
      }

      const childMarker = L.circleMarker(childLoc, {
        radius: 6,
        color: markerColor,
        fillColor: markerColor,
        fillOpacity: 0.9
      }).addTo(map);

      const address = await getReadableAddress(g.child_lat, g.child_lng);

      const row = document.querySelector(
        `tr[data-child-lat="${g.child_lat}"][data-child-lng="${g.child_lng}"]`
      );
      if (row) {
        const statusCell = row.querySelector(".status-cell");
        const locCell = row.querySelector(".location-cell");

        statusCell.innerHTML = inside 
          ? `<span style="color:green;">Inside</span>` 
          : `<span style="color:red;">Outside (${dist.toFixed(1)} m)</span>`;

        locCell.textContent = address;
      }

      childMarker.bindPopup(`
        <b>${g.firstname} ${g.lastname}</b><br>
        ${inside ? 'Inside' : 'Outside'} geofence<br>
        Distance: ${dist.toFixed(1)} m<br>
        Location: ${address}
      `);

      if (!inside) {
        L.polyline([childLoc, fenceCenter], { color: 'red', dashArray: '5, 10' }).addTo(map);
      }
    }
  }

  if (allCoords.length > 0) {
    const bounds = L.latLngBounds(allCoords);
    if (bounds.isValid()) map.fitBounds(bounds);
  }


  (function showGeoSummary() {
    const notifEl = document.getElementById("geoNotification");
    if (!notifEl) return;

    if (outsideList.length === 0) {
      notifEl.hidden = true;
      notifEl.textContent = "";
      return;
    }

    
    const names = outsideList.map(o => o.name);
    let formattedNames;
    if (names.length === 1) {
      formattedNames = names[0];
    } else if (names.length === 2) {
      formattedNames = `${names[0]} and ${names[1]}`;
    } else {
      formattedNames = `${names.slice(0, -1).join(', ')}, and ${names.slice(-1)}`;
    }

    let message;
    if (outsideList.length === 1) {
      const o = outsideList[0];
      message = `${formattedNames} is outside the geofence (${o.dist.toFixed(0)} meters).`;
    } else {
      message = `${formattedNames} are outside the geofence. Check the Status column.`;
    }

    const count = outsideList.length;
    const displayMessage = count === 1
      ? `Warning! 1 child is outside the geofence. Check the Status column.`
      : `Warning! ${count} children are outside the geofence. Check the Status column.`;

    notifEl.textContent = displayMessage;
    notifEl.hidden = false;
    setTimeout(() => notifEl.hidden = true, 20000); 


    (function speakCountOnly() {
      const ttsMessage = displayMessage;
      try {
        const utter = new SpeechSynthesisUtterance(ttsMessage);
        utter.rate = 0.95;
        utter.pitch = 1.05;
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      } catch (e) {
        console.warn("TTS not available:", e);
      }
    })();
  })();
}

renderGeofences();

document.querySelectorAll(".deleteChildBtn").forEach((btn) => {
  btn.addEventListener("click", async () => {
    const childId = btn.dataset.childId;
    const childName = btn.dataset.childName || "this child";
    const ok = confirm(`Delete ${childName} and ALL their records (locations, geofences)? This cannot be undone.`);
    if (!ok) return;

    try {
      const res = await fetch("/api/children/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ child_id: childId })
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ message: 'Delete failed' }));
        alert(err.message || "Failed to delete child");
        return;
      }
      // success: reload to refresh table/map
      alert(`${childName} deleted`);
      window.location.reload();
    } catch (err) {
      console.error("Delete error:", err);
      alert("Network error deleting child");
    }
  });
});

</script>

</body>
